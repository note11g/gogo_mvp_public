import 'package:flutter/material.dart';
import 'package:flutter_image_compress/flutter_image_compress.dart';
import 'package:get_it/get_it.dart';
import 'package:go_router/go_router.dart';
import 'package:gogo_mvp/presentation/src/core/global_container/main_container.dart';
import 'package:gogo_mvp/presentation/src/core/util/apple_login_util.dart';
import 'package:gogo_mvp/presentation/src/core/util/kakao_login_util.dart';
import 'package:gogo_mvp/presentation/src/design/color/go_color.dart';
import 'package:gogo_mvp_domain/entity/auth/login_platform.dart';
import 'package:gogo_mvp_domain/usecase/auth/delete_account_usecase.dart';
import 'package:gogo_mvp_domain/usecase/auth/sign_out_user_usecase.dart';
import 'package:url_launcher/url_launcher_string.dart';
import 'package:view_model_kit/view_model_kit.dart';

import 'package:gogo_mvp_domain/entity/user/soma_role.dart';
import '../../core/routing/routing.dart';
import '../../design/component/components.dart';
import '../../design/typo/typo.dart';
import '../../core/util/loading_util.dart';
import '../../core/util/photo_util.dart';
import '../../core/util/toast_util.dart';
import 'profile_setting_view_model.dart';

class ProfileSettingPage extends StatefulWidget {
  const ProfileSettingPage({super.key});

  @override
  State<ProfileSettingPage> createState() => _ProfileSettingPageState();
}

class _ProfileSettingPageState
    extends StateWithViewModel<ProfileSettingPage, ProfileSettingViewModel> {
  @override
  ProfileSettingViewModel createViewModel() => ProfileSettingViewModel();

  final _nameTextFieldController = TextEditingController();

  @override
  void initState() {
    super.initState();
    viewModel.name.observe((name) {
      if (_nameTextFieldController.text != name) {
        _nameTextFieldController.text = name;
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
        body: TextFieldFocusOutHelper(
            child: Stack(children: [
      SafeArea(
          child: Stack(children: [
        Column(mainAxisAlignment: MainAxisAlignment.center, children: [
          Expanded(child: _contentListSection()),
          _actionButton(),
        ]),
        if (!viewModel.isRegister.value) _backButtonSection(),
      ])),
      FullScreenLoadingIndicator(isLoading: viewModel.isLoading),
    ])));
  }

  Widget _backButtonSection() => Positioned(
      top: 0,
      left: 12,
      child: IconButton(
        icon: const Icon(Icons.arrow_back_ios, color: GoColors.secondaryGray),
        alignment: Alignment.centerRight,
        onPressed: () => context.pop(),
      ));

  Widget _contentListSection() => ListView(
          physics: const BouncingScrollPhysics(),
          padding: const EdgeInsets.symmetric(vertical: 24),
          keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
          children: [
            _profileSection(),
            const GoSpacer(32),
            _selectionSection(),
            const GoSpacer(24),
            _descriptionSection(),
          ]);

  Widget _actionButton() {
    final actionName = viewModel.isRegister.value ? "ÌöåÏõêÍ∞ÄÏûÖ" : "ÏàòÏ†ï";
    return FullCTAButton(actionName, enable: viewModel.doneFlag,
        onDisabledTap: () {
      if (!viewModel.isValid) {
        if (!viewModel.isNameValid) {
          context.openToast("Ïù¥Î¶ÑÏùÑ Ïã§Î™ÖÏúºÎ°ú Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        } else if (!viewModel.isProfileImageIsNotEmpty) {
          context.openToast("ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.");
        } else if (!viewModel.isRoleNotEmpty) {
          context.openToast("ÏÜåÎßàÏóêÏÑú Ïñ¥ÎñªÍ≤å Î∂àÎ¶¨ÏãúÎäîÏßÄ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
        } else if (!viewModel.isTagsNotEmpty) {
          context.openToast("ÏÜåÎßà ÏÇ¨ÎûåÎì§Í≥º ÌïòÍ≥† Ïã∂ÏùÄ Í±∏ Î™®Îëê Í≥®ÎùºÏ£ºÏÑ∏Ïöî.");
        }
      } else if (!viewModel.hasChange) {
        context.openToast("ÏàòÏ†ïÌï† Ï†ïÎ≥¥Í∞Ä ÏóÜÏñ¥Ïöî.");
      }
    }, onTap: () {
      context.load(() => viewModel.editProfile(
          onFailedUploadProfileImage: () =>
              context.openToast("ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§."),
          onDone: () {
            context.openToast("$actionNameÏóê ÏÑ±Í≥µÌïòÏòÄÏäµÎãàÎã§.");
            context.go(GoPages.home);
          }));
    });
  }

  Widget _profileSection() =>
      Column(crossAxisAlignment: CrossAxisAlignment.center, children: [
        _profileImageSection(),
        const GoSpacer(24),
        _nameTextFieldSection(),
      ]);

  Widget _profileImageSection() {
    return Column(crossAxisAlignment: CrossAxisAlignment.center, children: [
      ProfilePhotoView(
          onTap: _startPhotoPick, image: viewModel.profileImageUrl.value),
      const GoSpacer(4),
      LinkButton("ÏÇ¨ÏßÑ ÏàòÏ†ï", underline: false, onTap: _startPhotoPick),
    ]);
  }

  Widget _nameTextFieldSection() => Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: TextFieldTypeA(
          controller: _nameTextFieldController,
          label: "Ïù¥Î¶Ñ(Ïã§Î™Ö)",
          hint: "ÍπÄÏÜåÎßà",
          maxLength: 31,
          onChanged: (text) {
            viewModel.name.value = text;
          }));

  Widget _selectionSection() => Column(children: [
        _roleSelectionSection(),
        const GoSpacer(44),
        _tagSelectionSection(),
      ]);

  Widget _roleSelectionSection() => Column(children: [
        Text("ÏÜåÎßàÏóêÏÑú Ïñ¥ÎñªÍ≤å Î∂àÎ¶¨ÏãúÎÇòÏöî?",
            style: GoTypos.titleAtProfileSetting(),
            textAlign: TextAlign.center),
        const GoSpacer(16),
        MultiSelectionButtonUnit(
            selected: viewModel.role.value != SomaRole.none
                ? [viewModel.role.value.kor]
                : [],
            texts: SomaRole.getRoles(includeVisitor: viewModel.iOSReviewMode)
                .map((e) => e.kor)
                .toList(),
            margin: const EdgeInsets.symmetric(horizontal: 24),
            multiSelectionEnable: false,
            onChanged: (list) {
              viewModel.role.value = list.isNotEmpty
                  ? SomaRole.fromKor(list.first)
                  : SomaRole.none;
            }),
      ]);

  Widget _tagSelectionSection() => Column(children: [
        Text("ÏÜåÎßà ÏÇ¨ÎûåÎì§Í≥º ÌïòÍ≥† Ïã∂ÏùÄ Í±∏ Î™®Îëê Í≥®ÎùºÏ£ºÏÑ∏Ïöî",
            style: GoTypos.titleAtProfileSetting(),
            textAlign: TextAlign.center),
        const GoSpacer(4),
        Text("TIP : ÏÑ†ÌÉùÌïú ÏàúÏÑúÎåÄÎ°ú ÌôàÌôîÎ©¥Ïóê Î≥¥Ïó¨Ï†∏Ïöî üòâ",
            style: GoTypos.descriptionAtProfile(), textAlign: TextAlign.center),
        const GoSpacer(12),
        MultiSelectionButtonUnit(
            selected: viewModel.tags.value,
            texts: viewModel.allTags.value,
            showOrdering: true,
            margin: const EdgeInsets.symmetric(horizontal: 24),
            onChanged: viewModel.tags.change),
      ]);

  Widget _descriptionSection() => Column(children: [
        Row(
            mainAxisSize: MainAxisSize.min,
            textBaseline: TextBaseline.alphabetic,
            crossAxisAlignment: CrossAxisAlignment.baseline,
            children: [
              Text("Ïù¥Îü∞ ÌÉúÍ∑∏ ÏûàÏúºÎ©¥ Ï¢ãÍ≤†ÎäîÎç∞?", style: GoTypos.descriptionAtProfile()),
              LinkButton("ÌÉúÍ∑∏ Ï†úÏïàÌïòÍ∏∞",
                  onTap: _openTagSurvey, padding: const EdgeInsets.all(4)),
            ]),
        Text("Ï†úÏïàÌï¥Ï£ºÏã† ÌÉúÍ∑∏Í∞Ä Ï∂îÍ∞ÄÎêòÎ©¥ ÏïåÎ†§ÎìúÎ¶¥Í≤åÏöî!", style: GoTypos.descriptionAtProfile()),
        if (!viewModel.isRegister.value)
          _logoutOrDeleteAccountDialogOpenButton(),
      ]);

  Widget _logoutOrDeleteAccountDialogOpenButton() {
    return Padding(
      padding: const EdgeInsets.only(top: 16),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text("Î°úÍ∑∏ÏïÑÏõÉÏùÑ Ï∞æÏúºÏãúÎÇòÏöî?", style: GoTypos.descriptionAtProfile()),
          LinkButton("Í≥ÑÏ†ï Í¥ÄÎ¶¨",
              onTap: () => showDialog(
                  context: context,
                  builder: (context) => _AccountSettingDialog()),
              padding: const EdgeInsets.all(4)),
        ],
      ),
    );
  }

  void _startPhotoPick() async {
    try {
      final compressedImage = await context.load(
          () => PhotoUtil.pickImageFromGalleryAndCompressImage(
              format: CompressFormat.webp, compressQuality: 50),
          errorToast: false);
      if (compressedImage == null) return;
      viewModel.profileImageUrl.value = compressedImage;
    } on PhotoUtilException catch (e) {
      context.openToast(e.message);
    }
  }

  void _openTagSurvey() async {
    const url = "https://t0xa32reo6x.typeform.com/to/es2ZbDm5";
    if (!await launchUrlString(url)) {
      throw Exception('Could not launch $url');
    }
  }
}

class _AccountSettingDialog extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return GoDialog(
        child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
          Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                Text("Í≥ÑÏ†ï Í¥ÄÎ¶¨", style: GoTypos.updateDialogTitle()),
                RawButton(
                    padding: const EdgeInsets.all(4),
                    onTap: () => context.pop(),
                    child: const Icon(Icons.close_rounded,
                        color: GoColors.secondaryGray))
              ]),
          const GoSpacer(16),
          Text("Î°úÍ∑∏ÏïÑÏõÉÏùÑ ÏõêÌïòÏãúÎÇòÏöî?", style: GoTypos.updateDialogDescription()),
          LinkButton("Î°úÍ∑∏ÏïÑÏõÉ",
              onTap: () => _logout(context),
              padding: const EdgeInsets.symmetric(vertical: 6)),
          const GoSpacer(20),
          Text("Í≥ÑÏ†ï ÏÇ≠Ï†úÎ•º ÏõêÌïòÏãúÎÇòÏöî?", style: GoTypos.updateDialogDescription()),
          LinkButton("Í≥ÑÏ†ï ÏÇ≠Ï†ú",
              onTap: () => _deleteAccount(context),
              padding: const EdgeInsets.symmetric(vertical: 6)),
        ]));
  }

  void _logout(BuildContext context) {
    _cacheClear();
    context.load(GetIt.I.get<SignOutUserUseCase>()).then((_) {
      context.go(GoPages.welcome);
      context.openToast("Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.");
    });
  }

  void _deleteAccount(BuildContext context) {
    Future<void> deleteAccount() => GetIt.I.get<DeleteAccountUseCase>().call(
            onNeedReAuthenticate: (platform) async {
          await context.openToast("Í≥ÑÏ†ï Î≥¥ÏïàÏùÑ ÏúÑÌï¥, Îã§Ïãú Î°úÍ∑∏Ïù∏ÏùÑ ÏßÑÌñâÌï©ÎãàÎã§.", seconds: 2);
          return switch (platform) {
            GoLoginPlatform.kakao => KakaoLoginUtil.signInWithKakao(),
            GoLoginPlatform.apple => AppleLoginUtil.signInWithApple(),
          };
        });

    context.load(deleteAccount).then((_) {
      _cacheClear();
      context.go(GoPages.welcome);
      context.openToast("Í≥ÑÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
    });
  }

  void _cacheClear() {
    GetIt.I.get<MainContainer>().updateCachedMyInfo(null);
  }
}
